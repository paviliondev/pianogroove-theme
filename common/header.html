<script type="text/discourse-plugin" version="0.8">
  const container = Discourse.__container__;
  const { h } = require('virtual-dom');
  const { emojiUnescape } = require('discourse/lib/text');
  const RawHtml = require("discourse/widgets/raw-html").default;
  const { iconNode } = require("discourse-common/lib/icon-library");

  api.createWidget('pianogroove-header-widget', {
    tagName: 'div.pianogroove-header',
    buildKey: () => `pianogroove-header`,

    defaultState() {
      return {
        showMenu: false
      }
    },

    buildClasses(args) {
      return args.currentPath.split('.').join('-').dasherize();
    },

    html(args, state) {
      const controller = this.register.lookup('controller:navigation/category');
      const category = controller.get("category");
      const path = args.currentPath.toLowerCase();
      let contents = [];
      let header = [];
      let title;
      let description;

      if (path.indexOf('category') > -1) {
        header.push(h('div.image',
          h('img', {
            attributes: {
              src: Discourse.getURLWithCDN(category.get("uploaded_logo.url"))
            }
          })
        ));
        title = category.get('name');
        description = category.get('description');
      } else if (path.indexOf('categories') > -1) {
        title = settings.home_title;
        description = settings.home_description;
      }

      if (title || description) {
        let text = [];
        if (title) {
          text.push(h('div.title', title))
        }
        if (description) {
          text.push(h('div.description', new RawHtml({
            html: `<span>${emojiUnescape(description)}</span>`
          })))
        }
        header.push(h('div.text', text));
      }

      contents.push(h('div.header', h('div.header-wrapper', header)));

      let menu = [];

      if (this.site.mobileView) {
        menu.push(
          this.attach('link', {
            rawTitle: 'Forum Menu',
            rawLabel: 'Forum Menu',
            action: 'toggleMenu',
            className: 'btn btn-header',
            contents: () => {
              let icon = state.showMenu ? 'times' : 'bars'
              return [
                h('span', 'Forum Menu'),
                iconNode(icon)
              ];
            }
          })
        );

        if (state.showMenu) {
          menu.push(h('div.menu-items', this.menuItems()));
        }
      } else {
        menu.push(...this.menuItems());
      }

      contents.push(h('div.menu', menu));

      return h('div.content', contents);
    },

    toggleMenu() {
      this.state.showMenu = !this.state.showMenu;
    },

    menuItems() {
      const menuCategoriesSlugs = settings.menu_slugs.split(',');
      const menuCategories = this.site.categories.filter(c => menuCategoriesSlugs.indexOf(c.slug) > -1);
      let items = [];

      items.push(this.attach('link', {
        rawTitle: 'Forum Home',
        rawLabel: 'Forum Home',
        href: '/categories',
        className: 'btn btn-header',
        contents: () => {
          return [
            h('span', 'Forum Home'),
            h(`div.btn-image.home`)
          ];
        }
      }))

      menuCategories.forEach(c => {
        items.push(this.attach('link', {
          rawTitle: c.name,
          rawLabel: c.name,
          href: c.url,
          className: 'btn btn-header',
          contents: () => {
            return [
              h('span', c.name),
              h(`div.btn-image.${c.slug}`)
            ];
          }
        }));
      });

      return items;
    }
  })

  api.createWidget('guest-overlay', {
    tagName: 'div.guest-overlay',

    html(attrs) {
      const isMobile = this.site.mobileView;
      let contents = [];
      let text = [];
      let list = settings.guest_overlay_list.split('|');
      let cta = [];

      if (isMobile) {
        cta.push(h('div.title', settings.guest_overlay_title));
      } else {
        text.push(h('div.title', settings.guest_overlay_title));
        cta.push(h('div.logo', h('img', { attributes: { src: Discourse.SiteSettings.logo }})))
      }

      if (list) {
        list = list.map(item => h('li', item));
        text.push(h('div.list', h('ul', list)));
      }

      cta.push([
        this.attach('link', {
          href: '/join',
          rawLabel: 'Get Started',
          rawTitle: 'Get Started',
          className: 'btn btn-cta'
        }),
        h('div.login', [
          h('span', 'Do you have an account?'),
          this.attach('link', {
            href: '/login',
            rawLabel: 'Login',
            rawTitle: 'Login',
            className: 'login-link'
          })
        ])
      ]);

      let textNode = h('div.text', { attributes: { id: 'overlay-text' }}, text);
      let ctaNode = h('div.cta', { attributes: { id: 'overlay-cta' }}, cta);

      if (isMobile) {
        contents.push(ctaNode);
        contents.push(textNode);
      } else {
        contents.push(textNode);
        contents.push(ctaNode);
      }

      let html = [h('div.content', contents)];

      if (isMobile) {
        html.push(h('div.mobile-menu', [
            this.attach('link', {
              action: 'scrollTo',
              actionParam: 'overlay-cta',
              className: 'overlay-cta-link active'
            }),
            this.attach('link', {
              action: 'scrollTo',
              actionParam: 'overlay-text',
              className: 'overlay-text-link'
            })
          ])
        )
      }

      return html;
    },

    scrollTo(id) {
      let scrollLeft = $(`#${id}`).offset().left;
      if (scrollLeft !== 0) {
        $('.guest-overlay .content').animate({ scrollLeft }, 20, () => {
          console.log('running')
          $('.mobile-menu > a').removeClass('active');
          $(`.${id}-link`).addClass('active');
        });
      }
    }
  })

  api.createWidget('pianogroove-guest-overlay', {
    tagName: 'div.pianogroove-guest-overlay',

    html(args, state) {
      const path = args.currentPath.toLowerCase();
      let contents = [];

      $('html').css('overflow-y', 'scroll');

      if (path.indexOf('topic') > -1) {
        if (!this.currentUser) {
          contents.push(this.attach('guest-overlay'));
          Ember.run.scheduleOnce('afterRender', () => {
            $('html').css('overflow', 'hidden');
          });
        }
      }

      return contents;
    }
  });

  api.decorateWidget('pianogroove-header-widget:after', helper => {
    helper.widget.appEvents.on('page:changed', () => {
      helper.widget.scheduleRerender();
    });
  });

  api.decorateWidget('pianogroove-guest-overlay:after', helper => {
    helper.widget.appEvents.on('page:changed', () => {
      helper.widget.scheduleRerender();
    });
  });
</script>

<script type='text/x-handlebars' data-template-name='/connectors/below-site-header/pianogroove-header-container'>
  {{mount-widget widget="pianogroove-header-widget" args=(hash currentPath=currentPath)}}
  {{mount-widget widget="pianogroove-guest-overlay" args=(hash currentPath=currentPath)}}
</script>
